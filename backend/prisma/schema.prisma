generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String     @id @default(cuid())
  username               String
  discriminator          String
  displayName            String?
  email                  String     @unique
  pendingEmail           String?
  password               String
  avatar                 String? // Cloudinary URL
  avatarPublicId         String? // Cloudinary public ID for deletion
  banner                 String? // Cloudinary URL
  bannerPublicId         String? // Cloudinary public ID for deletion
  bio                    String?    @db.Text
  pronouns               String?
  themeColor             String?    @default("#5865F2")
  status                 UserStatus @default(offline)
  customStatus           String?
  customStatusEmoji      String?
  badges                 String[]   @default([])
  blockedUsers           String[]   @default([])
  
  // Relations
  sentFriendRequests     Friendship[] @relation("SentFriendships")
  receivedFriendRequests Friendship[] @relation("ReceivedFriendships")
  
  dmParticipants         DMParticipant[]
  
  servers                Json       @default("[]")
  settings               Json       @default("{}")
  isVerified             Boolean    @default(false)
  isBanned               Boolean    @default(false)
  lastSeen               DateTime   @default(now())
  createdAt              DateTime   @default(now())
  updatedAt              DateTime   @updatedAt
  
  // Account Security
  isDisabled             Boolean    @default(false)
  disabledAt             DateTime?
  emailVerificationToken String?
  emailVerificationTokenExpiry DateTime?


  // NEW: Profile Personalization
  location   String?
  cardStyle  String? @default("rounded") // rounded, sharp, glass
  fontStyle  String? @default("default") // default, modern, classic
  showBanner Boolean @default(true)

  // NEW: Social Links (JSON)
  socialLinks Json @default("{}")
  // { github: "", twitter: "", linkedin: "", portfolio: "", website: "" }

  // NEW: Privacy Settings (JSON)
  privacySettings Json @default("{}")
  // {
  //   emailVisible: "friends",
  //   mutualServersVisible: "everyone",
  //   friendRequestsFrom: "everyone",
  //   dmsFrom: "friends",
  //   showActivityStatus: true,
  //   showCurrentServer: true
  // }

  // NEW: Activity Tracking
  messagesSent     Int @default(0)
  voiceTimeMinutes Int @default(0)

  // NEW: Achievements
  achievements String[] @default([])

  ownedServers  Server[]       @relation("ServerOwner")
  serverMembers ServerMember[]
  userInterests UserInterest[]

  // Activity Tracking Relations
  dailyActivities UserDailyActivity[]
  activitySessions UserActivitySession[]
  invitesCreated   Invite[] @relation("Inviter")

  @@index([email])
  @@index([username])
}

model UserDailyActivity {
  id           String   @id @default(cuid())
  userId       String
  date         DateTime // Normalized to midnight
  count        Int      @default(0) // Total weighted activity
  messageCount Int      @default(0)
  voiceMinutes Int      @default(0)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model UserActivitySession {
  id        String    @id @default(cuid())
  userId    String
  type      String    // VOICE, etc.
  startTime DateTime  @default(now())
  endTime   DateTime?
  metadata  Json?     // { channelId: "..." }
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
}

model Server {
  id                String            @id @default(cuid())
  name              String
  ownerId           String
  icon              String?
  banner            String?
  description       String?
  membersCount      Int               @default(1)
  isPublic          Boolean           @default(false)
  verificationLevel VerificationLevel @default(none)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  channels          Channel[]
  roles             Role[]
  invites           Invite[]
  owner             User              @relation("ServerOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members           ServerMember[]

  @@index([ownerId])
}

model ServerMember {
  id       String   @id @default(cuid())
  serverId String
  userId   String
  roleIds  String[]
  joinedAt DateTime @default(now())
  isMuted  Boolean  @default(false)
  isBanned Boolean  @default(false)
  server   Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([serverId, userId])
  @@index([serverId])
  @@index([userId])
}

model Invite {
  id        String    @id @default(cuid())
  code      String    @unique
  serverId  String
  channelId String?
  inviterId String
  uses      Int       @default(0)
  maxUses   Int?
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  server    Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  inviter   User      @relation("Inviter", fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([serverId])
  @@index([inviterId])
}

model Channel {
  id                   String           @id @default(cuid())
  serverId             String
  name                 String
  type                 ChannelType      @default(TEXT)
  topic                String?
  position             Int              @default(0)
  permissionOverwrites Json             @default("[]")
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  server               Server           @relation(fields: [serverId], references: [id], onDelete: Cascade)
  messages             Message[]
  hashtags             ChannelHashtag[]

  @@index([serverId])
}

model Message {
  id          String      @id @default(cuid())
  channelId   String?
  dmRoomId    String?
  serverId    String?
  senderId    String
  content     String
  type        MessageType @default(TEXT)
  attachments Json        @default("[]")
  mentions    String[]
  isDeleted   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  channel     Channel?    @relation(fields: [channelId], references: [id], onDelete: Cascade)
  dmRoom      DMRoom?     @relation(fields: [dmRoomId], references: [id], onDelete: Cascade)

  @@index([channelId, createdAt(sort: Desc)])
  @@index([dmRoomId, createdAt(sort: Desc)])
  @@index([senderId])
  @@index([serverId])
}

model Friendship {
  id         String           @id @default(cuid())
  senderId   String
  receiverId String
  status     FriendshipStatus @default(PENDING)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  sender     User             @relation("SentFriendships", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User             @relation("ReceivedFriendships", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
}

model DMRoom {
  id           String          @id @default(cuid())
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  
  participants DMParticipant[]
  messages     Message[]
}

model DMParticipant {
  id        String   @id @default(cuid())
  dmRoomId  String
  userId    String
  joinedAt  DateTime @default(now())

  dmRoom    DMRoom   @relation(fields: [dmRoomId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([dmRoomId, userId])
  @@index([dmRoomId])
  @@index([userId])
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

model Role {
  id          String   @id @default(cuid())
  serverId    String
  name        String
  color       String?
  permissions Int      @default(0)
  position    Int      @default(0)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@index([serverId])
}

model Interest {
  id              String           @id @default(cuid())
  name            String           @unique
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  userInterests   UserInterest[]
  channelHashtags ChannelHashtag[]

  @@index([name])
}

model UserInterest {
  id         String   @id @default(cuid())
  userId     String
  interestId String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@unique([userId, interestId])
  @@index([userId])
  @@index([interestId])
}

model ChannelHashtag {
  id         String   @id @default(cuid())
  channelId  String
  interestId String
  createdAt  DateTime @default(now())
  channel    Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@unique([channelId, interestId])
  @@index([channelId])
  @@index([interestId])
}

enum ChannelType {
  TEXT
  VOICE
}

enum MessageType {
  TEXT
  FILE
  SYSTEM
}

enum UserStatus {
  online
  idle
  dnd
  offline
}

enum VerificationLevel {
  none
  low
  medium
  high
}
